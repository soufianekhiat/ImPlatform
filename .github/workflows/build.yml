name: Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  # ===========================================
  # Windows Builds - MSBuild (existing .sln)
  # ===========================================
  Build-Windows-MSBuild:
    runs-on: windows-2022
    name: Windows MSBuild - ${{ matrix.config }}

    strategy:
      fail-fast: false
      matrix:
        config:
          - Win32_DX9
          - Win32_DX10
          - Win32_DX11
          - Win32_DX12
          - Win32_OpenGL3
          - GLFW_OpenGL3
          - GLFW_Vulkan
          - SDL2_DX11
          - SDL2_OpenGL3
          - SDL2_Vulkan
          - SDL3_DX11
          - SDL3_OpenGL3
          - SDL3_Vulkan

    env:
      MSBUILD_PATH: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install SDL2
        if: startsWith(matrix.config, 'SDL2')
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/libsdl-org/SDL/releases/download/release-2.32.10/SDL2-devel-2.32.10-VC.zip" -OutFile "SDL2-devel.zip"
          Expand-Archive -Path SDL2-devel.zip -DestinationPath .
          $sdlPath = (Get-ChildItem -Directory -Filter "SDL2-*").FullName
          echo "SDL2_DIR=$sdlPath" >> $env:GITHUB_ENV
          echo "SDL2_INCLUDE=$sdlPath\include" >> $env:GITHUB_ENV
          echo "SDL2_LIB=$sdlPath\lib\x64" >> $env:GITHUB_ENV
          New-Item -ItemType Directory -Force -Path "ImPlatformDemo/x64/${{ matrix.config }}"
          Copy-Item "$sdlPath/lib/x64/SDL2.dll" "ImPlatformDemo/x64/${{ matrix.config }}/"

      - name: Install SDL3
        if: startsWith(matrix.config, 'SDL3')
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/libsdl-org/SDL/releases/download/release-3.2.26/SDL3-devel-3.2.26-VC.zip" -OutFile "SDL3-devel.zip"
          Expand-Archive -Path SDL3-devel.zip -DestinationPath .
          $sdlPath = (Get-ChildItem -Directory -Filter "SDL3-*").FullName
          echo "SDL3_DIR=$sdlPath" >> $env:GITHUB_ENV
          echo "SDL3_INCLUDE=$sdlPath\include" >> $env:GITHUB_ENV
          echo "SDL3_LIB=$sdlPath\lib\x64" >> $env:GITHUB_ENV
          New-Item -ItemType Directory -Force -Path "ImPlatformDemo/x64/${{ matrix.config }}"
          Copy-Item "$sdlPath/lib/x64/SDL3.dll" "ImPlatformDemo/x64/${{ matrix.config }}/"

      - name: Install Vulkan SDK
        if: contains(matrix.config, 'Vulkan')
        shell: powershell
        run: |
          # Download Vulkan SDK headers and libraries
          $vulkanVersion = "1.3.290.0"
          $vulkanUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
          Write-Host "Downloading Vulkan SDK $vulkanVersion..."
          Invoke-WebRequest -Uri $vulkanUrl -OutFile VulkanSDK-Installer.exe
          Write-Host "Installing Vulkan SDK (silent)..."
          Start-Process -FilePath .\VulkanSDK-Installer.exe -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait -NoNewWindow
          $vulkanPath = "C:\VulkanSDK\$vulkanVersion"
          echo "VULKAN_SDK=$vulkanPath" >> $env:GITHUB_ENV
          Write-Host "VULKAN_SDK set to: $vulkanPath"

      - name: Fix Project Files
        shell: powershell
        run: |
          Get-ChildItem -Recurse -Filter "*.vcxproj" | ForEach-Object {
            $content = Get-Content $_.FullName
            $content = $content -Replace "<PlatformToolset>v\d{3}</PlatformToolset>", "<PlatformToolset>v143</PlatformToolset>"
            $content = $content -Replace "<WindowsTargetPlatformVersion>[\d\.]+</WindowsTargetPlatformVersion>", '<WindowsTargetPlatformVersion>$(LatestTargetPlatformVersion)</WindowsTargetPlatformVersion>'
            Set-Content -Path $_.FullName -Value $content
          }

      - name: Debug Environment
        shell: powershell
        run: |
          Write-Host "=== Environment Variables ==="
          Write-Host "SDL2_INCLUDE: $env:SDL2_INCLUDE"
          Write-Host "SDL2_LIB: $env:SDL2_LIB"
          Write-Host "SDL3_INCLUDE: $env:SDL3_INCLUDE"
          Write-Host "SDL3_LIB: $env:SDL3_LIB"
          Write-Host "VULKAN_SDK: $env:VULKAN_SDK"
          if ($env:SDL2_INCLUDE) { Get-ChildItem $env:SDL2_INCLUDE -ErrorAction SilentlyContinue | Select-Object -First 5 }
          if ($env:SDL3_INCLUDE) { Get-ChildItem $env:SDL3_INCLUDE -ErrorAction SilentlyContinue | Select-Object -First 5 }

      - name: Build ${{ matrix.config }}
        shell: powershell
        run: |
          # vcxproj uses $(SDL2_INCLUDE), $(SDL2_LIB), $(SDL3_INCLUDE), $(SDL3_LIB), $(VULKAN_SDK) env vars
          & "$env:MSBUILD_PATH\MSBuild.exe" ImPlatformDemo/ImPlatformDemo.sln /p:Configuration=${{ matrix.config }} /p:Platform=x64 /m /nologo /v:normal

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-MSBuild-${{ matrix.config }}
          path: ImPlatformDemo/x64/${{ matrix.config }}/*.exe
          retention-days: 7

  # ===========================================
  # Windows Builds - CMake
  # ===========================================
  Build-Windows-CMake:
    runs-on: windows-2022
    name: Windows CMake

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/user-attachments/files/22464296/vulkan_windows_libs_1.4.326.zip" -OutFile vulkan_libs.zip
          Expand-Archive -Path vulkan_libs.zip -DestinationPath vulkan_sdk
          $vulkanPath = "${{ github.workspace }}\vulkan_sdk\vulkan_windows_libs_1.4.326"
          echo "VULKAN_SDK=$vulkanPath" >> $env:GITHUB_ENV
          echo "Vulkan_INCLUDE_DIR=$vulkanPath\Include" >> $env:GITHUB_ENV
          echo "Vulkan_LIBRARY=$vulkanPath\Lib\vulkan-1.lib" >> $env:GITHUB_ENV

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DIMPLATFORM_FETCH_DEPENDENCIES=ON

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-CMake-Windows
          path: build/Release/*.exe
          retention-days: 7

  # ===========================================
  # Linux Builds - CMake
  # ===========================================
  Build-Linux-CMake:
    runs-on: ubuntu-latest
    name: Linux CMake

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxext-dev \
            libwayland-dev \
            libxkbcommon-dev \
            libglfw3-dev \
            libsdl2-dev \
            libvulkan-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libdbus-1-dev \
            libdrm-dev \
            libgbm-dev \
            libegl1-mesa-dev

      - name: Install SDL3
        run: |
          # SDL3 is now on main branch
          git clone --depth 1 https://github.com/libsdl-org/SDL.git
          cd SDL
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=ON -DSDL_STATIC=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
        continue-on-error: true

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DIMPLATFORM_FETCH_DEPENDENCIES=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-CMake-Linux
          path: build/ImPlatformDemo_*
          retention-days: 7

  # ===========================================
  # macOS Builds - CMake
  # ===========================================
  Build-MacOS-CMake:
    runs-on: macos-latest
    name: macOS CMake

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install glfw sdl2 || true

      - name: Install SDL3
        run: |
          # Build SDL3 from source since it might not be in brew
          git clone --depth 1 https://github.com/libsdl-org/SDL.git
          cd SDL
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=ON -DSDL_STATIC=OFF
          cmake --build build -j$(sysctl -n hw.ncpu)
          sudo cmake --install build
        continue-on-error: true

      - name: Install Vulkan SDK
        run: |
          # Install MoltenVK for Vulkan support on macOS
          brew install molten-vk || true
        continue-on-error: true

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DIMPLATFORM_FETCH_DEPENDENCIES=ON

      - name: Build
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-CMake-macOS
          path: build/ImPlatformDemo_*
          retention-days: 7
