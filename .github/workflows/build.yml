name: Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  # ===========================================
  # Windows Builds - MSBuild (existing .sln)
  # ===========================================
  Build-Windows-MSBuild:
    runs-on: windows-2022
    name: Windows MSBuild - ${{ matrix.config }}

    strategy:
      fail-fast: false
      matrix:
        config:
          - Win32_DX9
          - Win32_DX10
          - Win32_DX11
          - Win32_DX12
          - Win32_OpenGL3
          - GLFW_OpenGL3
          - GLFW_Vulkan
          - SDL2_DX11
          - SDL2_OpenGL3
          - SDL2_Vulkan
          - SDL3_DX11
          - SDL3_OpenGL3
          - SDL3_Vulkan

    env:
      MSBUILD_PATH: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install SDL2
        if: startsWith(matrix.config, 'SDL2')
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/libsdl-org/SDL/releases/download/release-2.32.10/SDL2-devel-2.32.10-VC.zip" -OutFile "SDL2-devel.zip"
          Expand-Archive -Path SDL2-devel.zip -DestinationPath .
          $sdlPath = (Get-ChildItem -Directory -Filter "SDL2-*").FullName
          echo "SDL2_DIR=$sdlPath" >> $env:GITHUB_ENV
          echo "SDL2_INCLUDE=$sdlPath\include" >> $env:GITHUB_ENV
          echo "SDL2_LIB=$sdlPath\lib\x64" >> $env:GITHUB_ENV
          New-Item -ItemType Directory -Force -Path "ImPlatformDemo/x64/${{ matrix.config }}"
          Copy-Item "$sdlPath/lib/x64/SDL2.dll" "ImPlatformDemo/x64/${{ matrix.config }}/"

      - name: Install SDL3
        if: startsWith(matrix.config, 'SDL3')
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/libsdl-org/SDL/releases/download/release-3.2.26/SDL3-devel-3.2.26-VC.zip" -OutFile "SDL3-devel.zip"
          Expand-Archive -Path SDL3-devel.zip -DestinationPath .
          $sdlPath = (Get-ChildItem -Directory -Filter "SDL3-*").FullName
          echo "SDL3_DIR=$sdlPath" >> $env:GITHUB_ENV
          echo "SDL3_INCLUDE=$sdlPath\include" >> $env:GITHUB_ENV
          echo "SDL3_LIB=$sdlPath\lib\x64" >> $env:GITHUB_ENV
          New-Item -ItemType Directory -Force -Path "ImPlatformDemo/x64/${{ matrix.config }}"
          Copy-Item "$sdlPath/lib/x64/SDL3.dll" "ImPlatformDemo/x64/${{ matrix.config }}/"

      - name: Install Vulkan SDK
        if: contains(matrix.config, 'Vulkan')
        shell: powershell
        run: |
          # Download Vulkan SDK headers and libraries
          $vulkanVersion = "1.3.290.0"
          $vulkanUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
          Write-Host "Downloading Vulkan SDK $vulkanVersion..."
          Invoke-WebRequest -Uri $vulkanUrl -OutFile VulkanSDK-Installer.exe
          Write-Host "Installing Vulkan SDK (silent)..."
          Start-Process -FilePath .\VulkanSDK-Installer.exe -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait -NoNewWindow
          $vulkanPath = "C:\VulkanSDK\$vulkanVersion"
          echo "VULKAN_SDK=$vulkanPath" >> $env:GITHUB_ENV
          Write-Host "VULKAN_SDK set to: $vulkanPath"

      - name: Fix Project Files
        shell: powershell
        run: |
          Get-ChildItem -Recurse -Filter "*.vcxproj" | ForEach-Object {
            $content = Get-Content $_.FullName
            $content = $content -Replace "<PlatformToolset>v\d{3}</PlatformToolset>", "<PlatformToolset>v143</PlatformToolset>"
            $content = $content -Replace "<WindowsTargetPlatformVersion>[\d\.]+</WindowsTargetPlatformVersion>", '<WindowsTargetPlatformVersion>$(LatestTargetPlatformVersion)</WindowsTargetPlatformVersion>'
            Set-Content -Path $_.FullName -Value $content
          }

      - name: Build ${{ matrix.config }}
        shell: powershell
        run: |
          $msbuildArgs = @(
            "ImPlatformDemo/ImPlatformDemo.sln",
            "/p:Configuration=${{ matrix.config }}",
            "/p:Platform=x64",
            "/m",
            "/nologo",
            "/v:minimal"
          )

          # Pass SDL/Vulkan paths as MSBuild properties (more reliable than env vars)
          if ($env:SDL2_INCLUDE) {
            $msbuildArgs += "/p:SDL2_INCLUDE=$env:SDL2_INCLUDE"
            $msbuildArgs += "/p:SDL2_LIB=$env:SDL2_LIB"
          }
          if ($env:SDL3_INCLUDE) {
            $msbuildArgs += "/p:SDL3_INCLUDE=$env:SDL3_INCLUDE"
            $msbuildArgs += "/p:SDL3_LIB=$env:SDL3_LIB"
          }
          if ($env:VULKAN_SDK) {
            $msbuildArgs += "/p:VULKAN_SDK=$env:VULKAN_SDK"
          }

          & "$env:MSBUILD_PATH\MSBuild.exe" @msbuildArgs
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Run Demo and Capture Screenshot
        shell: powershell
        run: |
          $exePath = "ImPlatformDemo/x64/${{ matrix.config }}/ImPlatformDemo.exe"
          $screenshotDir = "screenshots"
          New-Item -ItemType Directory -Force -Path $screenshotDir

          Write-Host "Starting demo: $exePath"

          # Start the demo in background
          $process = Start-Process -FilePath $exePath -PassThru -WindowStyle Normal

          # Wait for the window to appear and render
          Start-Sleep -Seconds 3

          # Take screenshot using PowerShell
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing

          # Get screen bounds
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds

          # Create bitmap and capture
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)

          # Save screenshot
          $screenshotPath = "$screenshotDir/screenshot_${{ matrix.config }}.png"
          $bitmap.Save($screenshotPath, [System.Drawing.Imaging.ImageFormat]::Png)
          Write-Host "Screenshot saved to: $screenshotPath"

          # Cleanup
          $graphics.Dispose()
          $bitmap.Dispose()

          # Stop the demo
          if (!$process.HasExited) {
            $process.Kill()
            $process.WaitForExit(5000)
          }

          Write-Host "Demo stopped"
        continue-on-error: true

      - name: Upload Executable
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-MSBuild-${{ matrix.config }}
          path: ImPlatformDemo/x64/${{ matrix.config }}/*.exe
          retention-days: 7

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Screenshot-MSBuild-${{ matrix.config }}
          path: screenshots/*.png
          retention-days: 7
          if-no-files-found: ignore

  # ===========================================
  # Windows Builds - CMake
  # ===========================================
  Build-Windows-CMake:
    runs-on: windows-2022
    name: Windows CMake

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        shell: powershell
        run: |
          $vulkanVersion = "1.3.290.0"
          $vulkanUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
          Write-Host "Downloading Vulkan SDK $vulkanVersion..."
          Invoke-WebRequest -Uri $vulkanUrl -OutFile VulkanSDK-Installer.exe
          Write-Host "Installing Vulkan SDK (silent)..."
          Start-Process -FilePath .\VulkanSDK-Installer.exe -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait -NoNewWindow
          $vulkanPath = "C:\VulkanSDK\$vulkanVersion"
          echo "VULKAN_SDK=$vulkanPath" >> $env:GITHUB_ENV

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DIMPLATFORM_FETCH_DEPENDENCIES=ON

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Run Demo and Capture Screenshot
        shell: powershell
        run: |
          $screenshotDir = "screenshots"
          New-Item -ItemType Directory -Force -Path $screenshotDir

          # Find first available demo executable
          $exeFiles = Get-ChildItem -Path "build/Release" -Filter "ImPlatformDemo_*.exe" -ErrorAction SilentlyContinue
          if ($exeFiles.Count -eq 0) {
            $exeFiles = Get-ChildItem -Path "build" -Filter "ImPlatformDemo_*.exe" -Recurse -ErrorAction SilentlyContinue
          }

          if ($exeFiles.Count -gt 0) {
            $exePath = $exeFiles[0].FullName
            $exeName = $exeFiles[0].BaseName
            Write-Host "Starting demo: $exePath"

            $process = Start-Process -FilePath $exePath -PassThru -WindowStyle Normal
            Start-Sleep -Seconds 3

            Add-Type -AssemblyName System.Windows.Forms
            Add-Type -AssemblyName System.Drawing

            $screen = [System.Windows.Forms.Screen]::PrimaryScreen
            $bounds = $screen.Bounds
            $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
            $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
            $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)

            $screenshotPath = "$screenshotDir/screenshot_CMake_$exeName.png"
            $bitmap.Save($screenshotPath, [System.Drawing.Imaging.ImageFormat]::Png)
            Write-Host "Screenshot saved to: $screenshotPath"

            $graphics.Dispose()
            $bitmap.Dispose()

            if (!$process.HasExited) {
              $process.Kill()
              $process.WaitForExit(5000)
            }
          } else {
            Write-Host "No demo executables found"
          }
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-CMake-Windows
          path: build/Release/*.exe
          retention-days: 7

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Screenshot-CMake-Windows
          path: screenshots/*.png
          retention-days: 7
          if-no-files-found: ignore

  # ===========================================
  # Linux Builds - CMake
  # ===========================================
  Build-Linux-CMake:
    runs-on: ubuntu-latest
    name: Linux CMake

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxext-dev \
            libwayland-dev \
            libxkbcommon-dev \
            libglfw3-dev \
            libsdl2-dev \
            libvulkan-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libdbus-1-dev \
            libdrm-dev \
            libgbm-dev \
            libegl1-mesa-dev \
            xvfb \
            x11-utils \
            imagemagick

      - name: Install SDL3
        run: |
          git clone --depth 1 https://github.com/libsdl-org/SDL.git
          cd SDL
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=ON -DSDL_STATIC=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
        continue-on-error: true

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DIMPLATFORM_FETCH_DEPENDENCIES=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Demo and Capture Screenshot
        run: |
          mkdir -p screenshots

          # Find first available demo executable
          DEMO=$(find build -name "ImPlatformDemo_*" -type f -executable | head -1)

          if [ -n "$DEMO" ]; then
            DEMO_NAME=$(basename "$DEMO")
            echo "Starting demo: $DEMO"

            # Start Xvfb (virtual framebuffer)
            export DISPLAY=:99
            Xvfb :99 -screen 0 1280x720x24 &
            XVFB_PID=$!
            sleep 2

            # Run demo in background
            "$DEMO" &
            DEMO_PID=$!
            sleep 3

            # Capture screenshot using import (ImageMagick)
            import -window root "screenshots/screenshot_Linux_${DEMO_NAME}.png" || true

            # Cleanup
            kill $DEMO_PID 2>/dev/null || true
            kill $XVFB_PID 2>/dev/null || true

            echo "Screenshot captured"
          else
            echo "No demo executables found"
          fi
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-CMake-Linux
          path: build/ImPlatformDemo_*
          retention-days: 7

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Screenshot-CMake-Linux
          path: screenshots/*.png
          retention-days: 7
          if-no-files-found: ignore

  # ===========================================
  # macOS Builds - CMake
  # ===========================================
  Build-MacOS-CMake:
    runs-on: macos-latest
    name: macOS CMake

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install glfw sdl2 || true

      - name: Install SDL3
        run: |
          git clone --depth 1 https://github.com/libsdl-org/SDL.git
          cd SDL
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=ON -DSDL_STATIC=OFF
          cmake --build build -j$(sysctl -n hw.ncpu)
          sudo cmake --install build
        continue-on-error: true

      - name: Install Vulkan SDK
        run: |
          brew install molten-vk || true
        continue-on-error: true

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DIMPLATFORM_FETCH_DEPENDENCIES=ON

      - name: Build
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: Run Demo and Capture Screenshot
        run: |
          mkdir -p screenshots

          # Find first available demo executable
          DEMO=$(find build -name "ImPlatformDemo_*" -type f -perm +111 | head -1)

          if [ -n "$DEMO" ]; then
            DEMO_NAME=$(basename "$DEMO")
            echo "Starting demo: $DEMO"

            # Run demo in background
            "$DEMO" &
            DEMO_PID=$!
            sleep 3

            # Capture screenshot using screencapture
            screencapture -x "screenshots/screenshot_macOS_${DEMO_NAME}.png" || true

            # Cleanup
            kill $DEMO_PID 2>/dev/null || true

            echo "Screenshot captured"
          else
            echo "No demo executables found"
          fi
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImPlatformDemo-CMake-macOS
          path: build/ImPlatformDemo_*
          retention-days: 7

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Screenshot-CMake-macOS
          path: screenshots/*.png
          retention-days: 7
          if-no-files-found: ignore
